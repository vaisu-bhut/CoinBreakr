name: Build Custom Image with Packer

on:
  push:
    branches: [ main, staging ]

permissions:
  id-token: write
  contents: read

jobs:
  build-image:
    name: Build GCP Image via Packer
    if: github.repository == 'Clestique/CoinBreakr'   
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/379416821819/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: packer-github@coinbreakr.iam.gserviceaccount.com

      - name: ğŸ› ï¸ Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: coinbreakr

      - name: ğŸ” Verify Authentication
        run: gcloud auth list

      - name: ğŸ§© Install Packer
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip
          curl -fsSL https://releases.hashicorp.com/packer/1.11.0/packer_1.11.0_linux_amd64.zip -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          packer --version

      - name: ğŸ“¦ Create services.zip
        run: |
          echo "ğŸ“¦ Creating services.zip from services directory..."
          mkdir -p dist
          cd services
          zip -r ../dist/services.zip . -x "node_modules/*" "*.md" "*.log" ".git/*"
          cd ..
          if [ -f dist/services.zip ]; then
            echo "âœ… services.zip created successfully"
            ls -la dist/services.zip
            echo "ğŸ“Š Zip file size: $(du -h dist/services.zip | cut -f1)"
          else
            echo "âŒ Error: Failed to create services.zip"
            exit 1
          fi

      - name: ğŸ§  Initialize Packer
        working-directory: ./packer
        run: packer init .

      - name: âœ… Validate Template
        working-directory: ./packer
        run: packer validate packer.pkr.hcl

      - name: ğŸ—ï¸ Build Custom Image
        working-directory: ./packer
        run: |
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)  # Short SHA
          IMAGE_NAME="coinbreakr-$COMMIT_SHA"
          BRANCH_NAME="${{ github.ref_name }}"
          if [ "$BRANCH_NAME" = "main" ]; then
            IMAGE_FAMILY="coinbreakr-production-family"
          else
            IMAGE_FAMILY="coinbreakr-staging-family"
          fi
          echo "ğŸ—ï¸ Building image: $IMAGE_NAME (family: $IMAGE_FAMILY)"
          packer build \
            -var "project_id=coinbreakr" \
            -var "source_image_family=ubuntu-2404-lts-amd64" \
            -var "source_image_project_id=ubuntu-os-cloud" \
            -var "image_name=$IMAGE_NAME" \
            -var "image_family=$IMAGE_FAMILY" \
            -var "zone=us-central1-a" \
            -var "machine_type=e2-standard-2" \
            -var "ssh_username=packer" \
            -var "disk_size=10" \
            -var "disk_type=pd-standard" \
            -var "network=default" \
            -var "subnetwork=default" \
            packer.pkr.hcl

      - name: âœ… Verify Image Build
        run: |
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)  # Short SHA
          IMAGE_NAME="coinbreakr-$COMMIT_SHA"
          echo "ğŸ” Verifying image: $IMAGE_NAME"
          gcloud compute images describe "$IMAGE_NAME" --project coinbreakr
