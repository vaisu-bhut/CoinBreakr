name: Build Custom Image with Packer

on:
  push:
    branches:
      - main   

permissions:
  id-token: write
  contents: read

jobs:
  build-image:
    name: Build GCP Image via Packer
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚òÅÔ∏è Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/379416821819/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: packer-github@coinbreakr.iam.gserviceaccount.com

      - name: üõ†Ô∏è Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: coinbreakr

      - name: üîç Verify Authentication
        run: gcloud auth list

      - name: üß© Install Packer
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip
          curl -fsSL https://releases.hashicorp.com/packer/1.11.0/packer_1.11.0_linux_amd64.zip -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          packer --version

      - name: üì¶ Check services.zip
        run: |
          if [ ! -f packer/services.zip ]; then
            echo "‚ùå Error: packer/services.zip not found!"
            exit 1
          else
            echo "‚úÖ services.zip exists, ready for Packer."
          fi

      - name: üß† Initialize Packer
        working-directory: ./packer
        run: packer init .

      - name: ‚úÖ Validate Template
        working-directory: ./packer
        run: packer validate packer.pkr.hcl

      - name: üèóÔ∏è Build Custom Image
        working-directory: ./packer
        run: |
          PR_TITLE=$(echo "${{ github.event.pull_request.title }}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          SOURCE_BRANCH=$(echo "${{ github.head_ref }}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')
          TARGET_BRANCH=$(echo "${{ github.base_ref }}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)  # Short SHA

          IMAGE_NAME="coinbreakr:($PR_AUTHOR/$SOURCE_BRANCH)->($TARGET_BRANCH):PR-Title($PR_TITLE)-$COMMIT_SHA"
          echo "üèóÔ∏è Building image: $IMAGE_NAME"
          packer build -var "project_id=coinbreakr" -var "source_image_family=ubuntu-2404-lts-amd64" -var "source_image_project_id=ubuntu-os-cloud" -var "image_name=$IMAGE_NAME" -var "zone=us-central1-a" -var "machine_type=e2-medium" -var "ssh_username=packer" -var "disk_size=10" -var "disk_type=pd-standard" -var "network=default" -var "subnetwork=default" packer.pkr.hcl

      - name: ‚úÖ Verify Image Build
        run: |
          IMAGE_NAME="coinbreakr:($PR_AUTHOR/$SOURCE_BRANCH)->($TARGET_BRANCH):PR-Title($PR_TITLE)-$COMMIT_SHA"
          echo "üîç Verifying image: $IMAGE_NAME"
          gcloud compute images describe "$IMAGE_NAME" --project coinbreakr
