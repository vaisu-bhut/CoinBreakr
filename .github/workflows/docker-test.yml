name: Docker Build Test (Testing Branch)

on:
  pull_request:
    branches: [ testing ]

env:
  NODE_VERSION: '22'

jobs:
  docker-build-test:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: services/Dockerfile
          failure-threshold: warning

      - name: ğŸ—ï¸ Build Docker Image (Test)
        working-directory: ./services
        run: |
          docker build -t coinbreakr-api:test .
          echo "âœ… Docker image built successfully"

      - name: ğŸ” Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'coinbreakr-api:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ§ª Test Container Startup
        run: |
          echo "ğŸš€ Starting container..."
          docker run -d --name test-container \
            -e MONGO_URL="mongodb://test:test@localhost:27017/test" \
            -e JWT_SECRET="test-secret-key-for-testing-only" \
            -e NODE_ENV="production" \
            -p 3000:3000 \
            coinbreakr-api:test
          
          echo "â³ Waiting for container to start..."
          sleep 10
          
          echo "ğŸ” Checking container logs..."
          docker logs test-container
          
          echo "ğŸ§¹ Cleanup..."
          docker stop test-container
          docker rm test-container

  kubernetes-validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.0'

      - name: âœ… Validate K8s Manifests
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          kubectl apply --dry-run=client -f k8s/deployment.yaml
          kubectl apply --dry-run=client -f k8s/service.yaml
          kubectl apply --dry-run=client -f k8s/hpa.yaml
          kubectl apply --dry-run=client -f k8s/configmap.yaml
          echo "âœ… All Kubernetes manifests are valid"

  terraform-validate:
    name: Validate Terraform (K8s)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.3

      - name: ğŸ¯ Terraform Init
        working-directory: ./terraform-k8s
        run: terraform init -input=false

      - name: ğŸ“ Terraform Format Check
        working-directory: ./terraform-k8s
        run: terraform fmt -check -recursive

      - name: âœ… Terraform Validate
        working-directory: ./terraform-k8s
        run: terraform validate
