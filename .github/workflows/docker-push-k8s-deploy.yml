name: Build, Push & Deploy to Kubernetes

on:
  push:
    branches: [ testing ]

permissions:
  id-token: write
  contents: read

env:
  GCP_PROJECT_ID: coinbreakr
  GCP_REGION: us-east1
  GCP_ZONE: us-east1-b
  GKE_CLUSTER: coinbreakr-testing-cluster
  ARTIFACT_REGISTRY: us-east1-docker.pkg.dev
  REPOSITORY: coinbreakr-testing
  IMAGE_NAME: services

jobs:
  build-push-deploy:
    name: Build Docker Image & Deploy to GKE
    if: github.repository == 'Clestique/CoinBreakr'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF }}
          service_account: ${{ secrets.IAM }}

      - name: ðŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: ðŸ” Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}

      - name: ðŸ·ï¸ Generate Image Tags
        id: tags
        run: |
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          IMAGE_BASE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          
          echo "IMAGE_TAG_SHA=${IMAGE_BASE}:${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG_LATEST=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG_TIMESTAMP=${IMAGE_BASE}:${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Image tags:"
          echo "  - ${IMAGE_BASE}:${COMMIT_SHA}"
          echo "  - ${IMAGE_BASE}:latest"
          echo "  - ${IMAGE_BASE}:${TIMESTAMP}"

      - name: ðŸ³ Build Docker Image
        working-directory: ./services
        run: |
          echo "ðŸ—ï¸ Building Docker image..."
          docker build \
            -t ${{ steps.tags.outputs.IMAGE_TAG_SHA }} \
            -t ${{ steps.tags.outputs.IMAGE_TAG_LATEST }} \
            -t ${{ steps.tags.outputs.IMAGE_TAG_TIMESTAMP }} \
            .
          echo "âœ… Docker image built successfully"

      - name: ðŸ” Scan Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.tags.outputs.IMAGE_TAG_SHA }}
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“¤ Push Docker Image to Artifact Registry
        run: |
          echo "ðŸ“¤ Pushing images to Artifact Registry..."
          docker push ${{ steps.tags.outputs.IMAGE_TAG_SHA }}
          docker push ${{ steps.tags.outputs.IMAGE_TAG_LATEST }}
          docker push ${{ steps.tags.outputs.IMAGE_TAG_TIMESTAMP }}
          echo "âœ… Images pushed successfully"

      - name: ðŸ”§ Install GKE Auth Plugin
        run: |
          echo "ðŸ”Œ Installing gke-gcloud-auth-plugin..."
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: ðŸ”§ Configure kubectl
        run: |
          echo "ðŸ”§ Configuring kubectl..."
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GCP_ZONE }} --project ${{ env.GCP_PROJECT_ID }}
          
          echo "âœ… kubectl configured"
          kubectl version --client

      - name: ðŸ“‹ Apply ConfigMap
        run: |
          echo "ðŸ“‹ Applying ConfigMap..."
          kubectl apply -f k8s/configmap.yaml

      - name: ðŸš€ Deploy to Kubernetes
        run: |
          echo "ðŸš€ Deploying to Kubernetes..."
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml

      - name: ðŸ”„ Update Deployment Image
        run: |
          echo "ðŸ”„ Updating deployment with new image..."
          kubectl set image deployment/coinbreakr-api \
            api=${{ steps.tags.outputs.IMAGE_TAG_SHA }} \
            --record

      - name: â³ Wait for Rollout
        run: |
          echo "â³ Waiting for deployment rollout..."
          kubectl rollout status deployment/coinbreakr-api --timeout=5m

      - name: ðŸ” Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          kubectl get deployments
          kubectl get pods -l app=coinbreakr-api
          kubectl get services
          kubectl get hpa

      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ Performing health check..."
          
          # Get the external IP (may take a few minutes)
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get service coinbreakr-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$EXTERNAL_IP" ]; then
              echo "âœ… External IP: $EXTERNAL_IP"
              break
            fi
            echo "â³ Waiting for external IP... ($i/30)"
            sleep 10
          done
          
          if [ -z "$EXTERNAL_IP" ]; then
            echo "âš ï¸ External IP not yet assigned, but deployment is complete"
            exit 0
          fi
          
          # Test health endpoint
          echo "ðŸ” Testing health endpoint..."
          curl -f http://$EXTERNAL_IP/v1/healthz || echo "âš ï¸ Health check failed, but deployment is complete"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Kubernetes Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployment completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.tags.outputs.IMAGE_TAG_SHA }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.GKE_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get deployments,pods,services,hpa -l app=coinbreakr-api >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
