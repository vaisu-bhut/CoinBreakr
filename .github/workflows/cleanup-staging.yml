name: Cleanup Old Staging Instances

on:
  schedule:
    # Run daily at 2 AM UTC to clean up old staging instances
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-staging:
    name: Cleanup Old Staging Instances
    if: github.repository == 'Clestique/CoinBreakr'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF }}
          service_account: ${{ secrets.IAM }}

      - name: ğŸ› ï¸ Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: coinbreakr

      - name: ğŸ—‘ï¸ List and Clean Old Staging Instances
        run: |
          echo "ğŸ” Finding staging instances older than 7 days..."
          
          # Get instances with coinbreakr-staging prefix that are older than 7 days
          OLD_INSTANCES=$(gcloud compute instances list \
            --filter="name~coinbreakr-staging AND creationTimestamp<$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)" \
            --format="value(name,zone)" \
            --project=coinbreakr)
          
          if [ -z "$OLD_INSTANCES" ]; then
            echo "âœ… No old staging instances found to clean up"
            exit 0
          fi
          
          echo "ğŸ—‘ï¸ Found old staging instances to clean up:"
          echo "$OLD_INSTANCES"
          
          # Delete each old instance
          echo "$OLD_INSTANCES" | while read -r instance_name zone; do
            if [ -n "$instance_name" ] && [ -n "$zone" ]; then
              echo "ğŸ—‘ï¸ Deleting instance: $instance_name in zone: $zone"
              gcloud compute instances delete "$instance_name" \
                --zone="$zone" \
                --quiet \
                --project=coinbreakr || echo "âš ï¸ Failed to delete $instance_name"
            fi
          done
          
          echo "âœ… Cleanup completed"

      - name: ğŸ“Š Cleanup Summary
        run: |
          echo "## ğŸ—‘ï¸ Staging Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Cleanup completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Removed staging instances older than 7 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Cleanup:** Tomorrow at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
