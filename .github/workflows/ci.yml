name: CoinBreakr CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '22'
  MONGODB_VERSION: '6.0'

jobs:
  # Lint and Code Quality Check
  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/package-lock.json

      - name: Install dependencies
        working-directory: ./services
        run: npm ci

      - name: Run ESLint
        working-directory: ./services
        run: npx eslint . --ext .js --format=json --output-file=eslint-report.json || true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: services/eslint-report.json

  # Security and Dependency Check
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/package-lock.json

      - name: Install dependencies
        working-directory: ./services
        run: npm ci

      - name: Run security audit
        working-directory: ./services
        run: npm audit --audit-level=moderate

      - name: Check for known vulnerabilities
        working-directory: ./services
        run: npx audit-ci --config audit-ci.json || true

  # Packer Validation
  packer-validate:
    name: Packer Validate
    needs: [lint, security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3.1.0
        with:
          version: "1.14.0" 

      - name: packer fmt (check)
        run: |
          packer fmt -check -recursive .

      - name: packer validate
        run: |
          packer validate packer.pkr.hcl

  # Terraform Format & Validation
  terraform:
    name: Terraform Format & Validate
    runs-on: ubuntu-latest
    needs: [lint, security, packer-validate] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.3

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -input=false

      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate
