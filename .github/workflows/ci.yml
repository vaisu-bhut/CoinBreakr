name: CoinBreakr CI/CD Pipeline

on:
  pull_request:
    branches: [ main, dev ]

env:
  NODE_VERSION: '22'
  MONGODB_VERSION: '6.0'

jobs:
  # Lint and Code Quality Check
  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/package-lock.json

      - name: Install dependencies
        working-directory: ./services
        run: npm ci

      - name: Run ESLint
        working-directory: ./services
        run: npx eslint . --ext .js --format=json --output-file=eslint-report.json || true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: services/eslint-report.json

  # Database and Service Tests
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      mongodb:
        image: mongo:${{ env.MONGODB_VERSION }}
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        test-suite: [smoke, database, integration ]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/package-lock.json

      - name: Install dependencies
        working-directory: ./services
        run: npm ci

      - name: Wait for MongoDB
        run: |
          until mongosh --host localhost:27017 --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
            echo "Waiting for MongoDB to start..."
            sleep 2
          done
          echo "MongoDB is ready!"

      - name: Set up test environment
        working-directory: ./services
        run: |
          echo "NODE_ENV=test" >> .env
          echo "JWT_SECRET=test-secret-key-for-github-actions" >> .env
          echo "MONGODB_URI=mongodb://localhost:27017/coinbreakr-test" >> .env
          echo "PORT=3001" >> .env

      - name: Run ${{ matrix.test-suite }} tests
        working-directory: ./services
        run: npm run test:run-${{ matrix.test-suite }}
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret-key-for-github-actions
          MONGODB_URI: mongodb://localhost:27017/coinbreakr-test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            services/coverage/
            services/test-results/
          retention-days: 7

  # Security and Dependency Check
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/package-lock.json

      - name: Install dependencies
        working-directory: ./services
        run: npm ci

      - name: Run security audit
        working-directory: ./services
        run: npm audit --audit-level=moderate

      - name: Check for known vulnerabilities
        working-directory: ./services
        run: npx audit-ci --config audit-ci.json || true
        