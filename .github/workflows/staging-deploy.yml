name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Build Custom Image with Packer"]
    types: [completed]
    branches: [staging]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    if: github.repository == 'Clestique/CoinBreakr' && ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/379416821819/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: packer-github@coinbreakr.iam.gserviceaccount.com

      - name: ðŸ› ï¸ Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: coinbreakr

      - name: ðŸ” Verify Authentication
        run: gcloud auth list

      - name: ðŸ“¦ Get Latest Image
        id: get-image
        run: |
          echo "ðŸ” Finding latest image from coinbreakr-image-family..."
          LATEST_IMAGE=$(gcloud compute images list --filter="family:coinbreakr-staging-family" --format="value(name)" --sort-by="~creationTimestamp" --limit=1)
          if [ -z "$LATEST_IMAGE" ]; then
            echo "âŒ No images found in coinbreakr-image-family"
            exit 1
          fi
          echo "âœ… Found latest image: $LATEST_IMAGE"
          echo "image_name=$LATEST_IMAGE" >> $GITHUB_OUTPUT
          echo "image_url=gcr.io/coinbreakr/$LATEST_IMAGE" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Setup Terraform
        run: |
          echo "ðŸ“¦ Installing Terraform..."
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install terraform -y
          terraform --version

      - name: ðŸ—‚ï¸ Initialize Terraform
        working-directory: ./terraform
        run: |
          echo "ðŸ—‚ï¸ Initializing Terraform..."
          terraform init

      - name: âœ… Validate Terraform Configuration
        working-directory: ./terraform
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate

      - name: ðŸ“‹ Plan Terraform Deployment
        working-directory: ./terraform
        run: |
          echo "ðŸ“‹ Planning Terraform deployment..."
          terraform plan \
            -var="project_id=coinbreakr" \
            -var="region=us-central1" \
            -var="zone=us-central1-a" \
            -var="instance_name=coinbreakr-staging-$(date +%Y%m%d-%H%M%S)" \
            -var="image_family=coinbreakr-staging-family" \
            -var="machine_type=e2-small" \
            -var="ssh_user=terraform" \
            -var="ssh_public_key_path=/dev/null" \
            -out=tfplan

      - name: ðŸš€ Apply Terraform Deployment
        working-directory: ./terraform
        run: |
          echo "ðŸš€ Applying Terraform deployment..."
          terraform apply -auto-approve \
            -var="project_id=coinbreakr" \
            -var="region=us-central1" \
            -var="zone=us-central1-a" \
            -var="instance_name=coinbreakr-staging-$(date +%Y%m%d-%H%M%S)" \
            -var="image_family=coinbreakr-staging-family" \
            -var="machine_type=e2-small" \
            -var="ssh_user=terraform" \
            -var="ssh_public_key_path=/dev/null"

      - name: ðŸ“Š Get Instance Information
        working-directory: ./terraform
        run: |
          echo "ðŸ“Š Getting instance information..."
          INSTANCE_NAME=$(terraform output -raw instance_name 2>/dev/null || echo "coinbreakr-staging-$(date +%Y%m%d-%H%M%S)")
          EXTERNAL_IP=$(gcloud compute instances describe $INSTANCE_NAME --zone=us-central1-a --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null || echo "Not available")
          
          echo "ðŸŽ‰ Deployment completed!"
          echo "Instance Name: $INSTANCE_NAME"
          echo "External IP: $EXTERNAL_IP"
          echo "Application URL: http://$EXTERNAL_IP:3000/v1/healthz"
